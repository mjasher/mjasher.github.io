<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">

<link href="../../third/bootstrap.2.3.1.min.css" rel="stylesheet">           
<style>

html,body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
  overflow: hidden;
/*  font: 10px sans-serif;*/
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

    
#input,#graph {
    position: absolute;
    width: 50%;
    height: 100%;
}
#input{
    background-color: black;
    background-image: url("/nz/img/Map_of_New_Zealand.svg");
    background-size: 100% 100%;
    overflow: auto;
}
#graph{
    left: 50%;
}
#household_form, #household_results{
    color: white;
}

input[type=text], input[type=number], select{
    background-color: transparent;
    color: white;
}

    
</style>
</head>
<body> 

    
<div id="input">
<div id="household_form"></div>
    
    
    
<div id="household_results"></div>
<!--<embed src="/nz/img/Map_of_New_Zealand.svg"> -->
</div>
<div id="graph"></div>
    

<script src="../../third/d3.min.js"></script>
<script src="../../third/jquery-1.11.0.min.js"></script>
<script src="../../third/underscore.min.js"></script>
<script src="../../third/backbone.min.js"></script>
<script src="js/nz.js"></script>

<script type="text/template" id="household_form_template">
   
<h2>New Zealand Tax &amp Welfare Calculator</h2>

<form class="form-horizontal">
<fieldset>

    
<!-- partner? -->
<div class="control-group">
  <label class="control-label" for="radios">Number of earners in your family </label>
  <div class="controls">
    <label class="radio" for="radios-0">
      <input name="partner" id="radios-0" value="single" <% if (partner==='single') { print("checked='checked'"); } %> type="radio" >
     one
    </label>
    <label class="radio" for="radios-1">
      <input name="partner" id="radios-1" value="couple" <% if (partner==='couple') { print("checked='checked'"); } %>  type="radio">
      two
    </label>
  </div>
</div>
   
<!--your details-->
<h4> You - primary earner </h4>
<div class="control-group">
  <label class="control-label" for="income">Annual gross taxable income ($)</label>
  <div class="controls">
    <input id="income" class="input-xlarge" type="number" step="1000"  value="<%= income %>">
     
  </div>
</div>
<div class="control-group">
  <label class="control-label" for="hours">Hours worked per week</label>
  <div class="controls">
    <input id="hours" class="input-xlarge" type="number" step="5"  value="<%= hours %>">
  </div>
</div>

<!--    partner details -->
<% if (partner === 'couple') { %>
<h4> Your spouse/partner </h4>
<div class="control-group">
  <label class="control-label" for="income">Partner's gross annual income ($)</label>
  <div class="controls">
    <input id="partner_income" class="input-xlarge" type="number" step="1000" value="<%= partner_income %>">
     
  </div>
</div>
<div class="control-group">
  <label class="control-label" for="hours">Partner's hours worked per week</label>
  <div class="controls">
    <input id="partner_hours" class="input-xlarge" type="number" step="5"  value="<%= partner_hours %>">
  </div>
</div>
  <% } %>
    
<!-- children-->
<%= children_view %>
<!-- tax -->
<div class="control-group">
  <label class="control-label" for="radios">Baby bonus policy</label>
  <div class="controls">
    <label class="radio" for="radiosT-0">
<input type="radio" id="radiosT-0" name="baby_bonus" value="best_start" <% if (baby_bonus==='best_start') { print("checked='checked'"); } %> >Best Start baby bonus (Labour's proposed credit)
    </label>
    <label class="radio" for="radiosT-1">
    <input type="radio" id="radiosT-1" name="baby_bonus" value="current_credit" <% if (baby_bonus==='current_credit') { print("checked='checked'"); } %> > Parental Tax Credit, 2014-15 (maximum of $150 for 8 weeks)
    </label>
    <label class="radio" for="radiosT-2">
    <input type="radio" id="radiosT-2" name="baby_bonus" value="new_credit" <% if (baby_bonus==='new_credit') { print("checked='checked'"); } %> > Parental Tax Credit, effective from 1 April 2015 (maximum of $220 for 10 weeks)
    </label>
  </div>
</div>
 
    
</fieldset>
</form>

</script>    

<script type="text/template" id="children_template">
<!-- Select Basic -->
<h4> Children </h4>
<div class="control-group">
  <label class="control-label" for="selectbasic">0-1 years old</label>
  <div class="controls">
    <select class="children" id="children-0to1" name="selectbasic" class="input-mini">
      <option <% if (children0to1===0) { print("selected='selected'"); } %> >0</option>
      <option <% if (children0to1===1) { print("selected='selected'"); } %> >1</option>
      <option <% if (children0to1===2) { print("selected='selected'"); } %>>2</option>
      <option <% if (children0to1===3) { print("selected='selected'"); } %>>3</option>
      <option <% if (children0to1===4) { print("selected='selected'"); } %>>4</option>
    </select>
  </div>
</div>
<div class="control-group">
  <label class="control-label" for="selectbasic">2-3 years old</label>
  <div class="controls">
    <select class="children" id="children-1to3" name="selectbasic" class="input-mini">
      <option <% if (children1to3===0) { print("selected='selected'"); } %>>0</option>
      <option <% if (children1to3===1) { print("selected='selected'"); } %>>1</option>
      <option <% if (children1to3===2) { print("selected='selected'"); } %>>2</option>
      <option <% if (children1to3===3) { print("selected='selected'"); } %>>3</option>
      <option <% if (children1to3===4) { print("selected='selected'"); } %>>4</option>
    </select>
  </div>
</div>
<div class="control-group">
  <label class="control-label" for="selectbasic">4-12 years old</label>
  <div class="controls">
    <select class="children" id="children-3to12" name="selectbasic" class="input-mini">
      <option <% if (children3to12===0) { print("selected='selected'"); } %>>0</option>
      <option <% if (children3to12===1) { print("selected='selected'"); } %> >1</option>
      <option <% if (children3to12===2) { print("selected='selected'"); } %>>2</option>
      <option <% if (children3to12===3) { print("selected='selected'"); } %>>3</option>
      <option <% if (children3to12===4) { print("selected='selected'"); } %>>4</option>
    </select>
  </div>
</div>
<div class="control-group">
  <label class="control-label" for="selectbasic">13-15 years old</label>
  <div class="controls">
    <select class="children" id="children-13to15" name="selectbasic" class="input-mini">
      <option <% if (children13to15===0) { print("selected='selected'"); } %>>0</option>
      <option <% if (children13to15===1) { print("selected='selected'"); } %>>1</option>
      <option <% if (children13to15===2) { print("selected='selected'"); } %>>2</option>
      <option <% if (children13to15===3) { print("selected='selected'"); } %>>3</option>
      <option <% if (children13to15===4) { print("selected='selected'"); } %>>4</option>
    </select>
  </div>
</div>
<div class="control-group">
  <label class="control-label" for="selectbasic">16-18 years old</label>
  <div class="controls">
    <select class="children" id="children-15to18" name="selectbasic" class="input-mini">
      <option <% if (children15to18===0) { print("selected='selected'"); } %>>0</option>
      <option <% if (children15to18===1) { print("selected='selected'"); } %>>1</option>
      <option <% if (children15to18===2) { print("selected='selected'"); } %>>2</option>
      <option <% if (children15to18===3) { print("selected='selected'"); } %>>3</option>
      <option <% if (children15to18===4) { print("selected='selected'"); } %>>4</option>
    </select>
  </div>
</div>
</script>
    
    
<script type="text/template" id="household_results_template">

  <table class='table table-condensed'>
<tr>
  <th></th>
  <th>Taxable income <br> ($)</th>
  <th>Tax payable <br> ($)</th>
  <th>ACC <br> ($)</th>
  <th>Household credits <br> ($)</th>
  <th>Average tax rate <br> (%)</th>
  <th>Effective marginal tax rate <br> (%)</th>
</tr>
<tr>
  <td>You</td>
  <td><%= income %></td>
  <td><%= tax %></td>
  <td><%= acc %></td>
  <td><%= credits %></td>
  <td><%= average_rate %></td>
  <td><%= marginal_rate %></td>
</tr>
<% if (partner === 'couple') { %>
<tr>
  <td>Your partner</td>
  <td><%= partner_income %></td>
  <td><%= partner_tax %></td>
  <td><%= partner_acc %></td>
  <td><%= partner_credits %></td>
  <td><%= partner_average_rate %></td>
  <td><%= partner_marginal_rate %></td>
</tr>
<tr>
  <td>TOTAL</td>
  <td><%= partner_income + income %></td>
  <td><%= total_tax %></td>
  <td><%= total_acc %></td>
  <td></td>
  <td></td>
  <td></td>
</tr>
<% } %>
</table> 

<p> The graph shows the effective marginal and average tax rates for you, the primary earner, based on your spouse's income entered above. </p>

<p>Disclaimer:<p>

<p>The NZTWC is provided for information and illustrative purposes. The NZTWC is not intended to be financial advice, nor should it be used in this way.</p> 

<p>All reasonable care has been taken in preparing and designing the NZTWC; however, we provide no warranties and make no representation that the information provided by the NZTWC is appropriate for your particular circumstances or indicates you should follow a particular course of action.</p>
<p> Designed by Steve Thomas. Coded by Michael Asher. </p>
</script> 

<script>
    

    

var HouseholdGraph = Backbone.View.extend({
    initialize: function(){
        var view = this;
        
        this.model.on('change', this.render, this);
        window.onresize = function updateWindow(){
            view.render();
        };
        this.render();
    },
    
    render: function(){
        d3.selectAll("#graph svg").remove();
        var household = this.model.toJSON();
        var avg;

        var graphElement = document.getElementById('graph');
        var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = graphElement.clientWidth - margin.left - margin.right,
            height = graphElement.clientHeight - margin.top - margin.bottom;

        var data = [];
        var previous;
        for (var i=0;i<180000;i+=100){
            household.income = i;
            household.partner_income = Math.round(household.partner_income/100)*100;
            avg = average_tax_rate(household).you;
            avg = avg>-50 ? avg : -50;
            data.push({income: i,
                       values: {
                           'marginal_rate': marginal_tax_rate(household).you,
                           'average_rate': avg 
                       }});
        }

        var x = d3.scale.linear()
            .range([0, width]);

        var y = d3.scale.linear()
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var line = d3.svg.line()
            .x(function(d) { return x(d.income); })
            .y(function(d) { return y(d.values.marginal_rate); });

        var svg = d3.select("#graph").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          x.domain(d3.extent(data, function(d) { return d.income; }));
//          y.domain(d3.extent(data, function(d) { return d.values.marginal_rate; }));
          y.domain([-10,60]);
       
          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
            .append("text")
                .attr('x', width)
                .attr('y', -6)
                .style("text-anchor", "end")
                .text("Your taxable income ($)");;

          svg.append("g")
              .attr("class", "y axis")
              .call(yAxis)
            .append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 6)
              .attr("dy", ".71em")
              .style("text-anchor", "end")
              .text("Tax rate (%)");
        
        
          svg.append("path")
              .datum(data)
              .attr("class", "line")
              .attr("d", line);
        
        var redline = d3.svg.line()
            .x(function(d) { return x(d.income); })
            .y(function(d) { return y(d.values.average_rate); });
        
          svg.append("path")
              .datum(data)
              .attr("class", "line")
              .style("stroke", "red")   
              .attr("d", redline);
              
           svg.append('rect')
            .style('color','grey')
            .attr('width',width)
            .attr('height',1)
            .attr('x', x(0))
            .attr('y', y(0))
            

        svg.append('text')
            .text('Effective marginal and average tax rates for primary earner')
             .style('color','grey')
            .attr('x', x(10000))
            .attr('y', y(60))
        
     var legend = svg.selectAll(".legend")
          .data([{label:'Effective marginal tax rate', color:'steelblue'}, {label:'Average tax rate', color: 'red'}])
        .enter().append("g")
          .attr("class", "legend")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
          .attr("x", width - 18)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", function(d){return d.color;});

      legend.append("text")
          .attr("x", width - 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style('font-size', '12px')
          .style("text-anchor", "end")
          .text(function(d) { return d.label; });

    }
});
    
var ChildrenForm = Backbone.View.extend({
    id: "children",
    initialize: function(){
        this.model.on('change', this.render, this);
        junk = this.$el;
    },
    
    template: _.template($("#children_template").html()),  

    events: {
        // Moved to parent view. weird
        
    },

    render: function() {  
        //console.log(this.model.attributes);
        var children = this.model.get('children');
        this.$el.html(this.template({
            children0to1: children.filter(function(c){ if(c < 1) return true; else return false;}).length,
            children1to3: children.filter(function(c){ if(c >= 1 && c < 3) return true; else return false;}).length,
            children3to12: children.filter(function(c){ if(c >= 3 && c < 12) return true; else return false;}).length,
            children13to15: children.filter(function(c){ if(c >= 12 && c < 15) return true; else return false;}).length,
            children15to18: children.filter(function(c){ if(c >= 15 && c < 19) return true; else return false;}).length        
        }));
        return this;
   }

});
    
    
var HouseholdForm = Backbone.View.extend({

    initialize: function(){
        this.model.on('change', this.render, this);
        this.render();
    },
    
    template: _.template($("#household_form_template").html()),  

    events: {
     'change #income' : function(e){   this.model.set('income', +e.target.value); },
     'change #partner_income' : function(e){   this.model.set('partner_income', +e.target.value); },
     'change #hours' : function(e){   this.model.set('hours', +e.target.value); },
     'change #partner_hours' : function(e){   this.model.set('partner_hours', +e.target.value); },

     'change [name="partner"]' : function(e){   this.model.set('partner', e.target.value); },
     'change [name="baby_bonus"]' : function(e){   this.model.set('baby_bonus', e.target.value); },
     
     'change .children' : function(){ 
         var children = [];
         for(var i=0;i<this.$el.find('#children-0to1').val();i++){
             children.push(0);
         }
         for(var i=0;i<this.$el.find('#children-1to3').val();i++){
             children.push(2);
         }
          for(var i=0;i<this.$el.find('#children-3to12').val();i++){
             children.push(5);
         }
         for(var i=0;i<this.$el.find('#children-13to15').val();i++){
             children.push(14);
         }
         for(var i=0;i<this.$el.find('#children-15to18').val();i++){
             children.push(17);
         }         
         this.model.set('children', children);
     },
        
        
    },

    render: function() {  
        //console.log(this.model.attributes);
        var childrenForm = new ChildrenForm({model: this.model});
        this.$el.html(this.template($.extend(this.model.attributes, {children_view: childrenForm.render().el.innerHTML})));
        return this;
   }

});

var HouseholdResults= Backbone.View.extend({

    initialize: function(){
        this.model.on('change', this.render, this);
        this.render();
    },
    
    template: _.template($("#household_results_template").html()),  

    render: function() {  
        
        var household = this.model.toJSON();

        var average_rate = average_tax_rate(household);
        var marginal_rate = marginal_tax_rate(household);

            //console.log(parental_tax_credit(household),best_start(household), family_tax_credit(household),in_work_tax_credit(household));
        
        this.$el.html(this.template({
            partner: household.partner,
            income: household.income,
            tax: tax(household.income).toFixed(2),
            acc: acc(household.income).toFixed(2),
            credits:total_credits(household).toFixed(2),
            average_rate: isNaN(average_rate.you) ? 'NA' : average_rate.you.toFixed(2),
            marginal_rate: marginal_rate.you.toFixed(2),
            partner_income: household.partner_income,
            partner_tax: tax(household.partner_income).toFixed(2),
            partner_acc: acc(household.partner_income).toFixed(2),
            partner_credits:'NA',
            partner_average_rate: isNaN(average_rate.partner) ? 'NA' : average_rate.partner.toFixed(2),
            partner_marginal_rate: marginal_rate.partner.toFixed(2),
            total_tax: (tax(household.income)+tax(household.partner_income)).toFixed(2),
            total_acc: (acc(household.income)+acc(household.partner_income)).toFixed(2),
        }));
        return this;
   }

});

    
var householdModel = new Backbone.Model({
  'income': 56308,
  'hours': 40,
  'partner': 'couple',
  'partner_income': 28154,
  'partner_hours': 20,
  'children': [0,1,5],
  'baby_bonus': 'current_credit',
   combined_income: function() {
    if (this.partner === 'single') {
      return this.income;
    } else {
      return this.income + this.partner_income;
    }
  }
});
    
var householdForm = new HouseholdForm({model: householdModel,
                                      el: $("#household_form")});

var householdResults = new HouseholdResults({model: householdModel,
                                      el: $("#household_results")});

var householdGraph = new HouseholdGraph({model: householdModel});
    

</script>
</body> 
</html>