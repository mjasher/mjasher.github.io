<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

span.site{
  border: 0.02px solid black;
  margin: 2px;
  padding: 3px;
  display: inline-block;
  cursor: pointer;
  /*margin: 5px;*/
}

.active{
  background-color: lightsteelblue;
}

.background {
  fill: #eee;
}

line {
  stroke: #fff;
}

text.active {
  fill: steelblue;
  font-weight: bold;
}

</style>
<body>
<div id='timeseries'></div>
<h4>Species, click to include/exclude. Sorted decreasing number of observations. <span class='site' id='species-all'>all </span> <span class='site' id='species-none'>none </span> </h4>
<!-- Filter species by regex: <input id='species-regex' type="text"> -->
<div id='species'></div>
<h4>Sites, click to choose. Sorted decreasing number of observations.</h4>
<div id='sites'></div>

<script src='../../third/d3.min.js'></script>
<script src='cross_correlation.js'></script>
<script src='cross_correlation_graph.js'></script>
<script>

/*
Data: observations, site_filter, species_filter
View: multi timeseries graph, sites, species
Interaction: change filter, scale, new observations
*/


function exclude(string){
  return ! species_filter.exclude_set.has(string);
  // for (var i = 0; i < species_filter.exclude_regex.length; i++) {
  //   if ( string.match(species_filter.exclude_regex[i]) ) return true;
  // };
  // if (species_filter.exclude_set.has(string)) return true;
  // return false;
}


// MODELS - at this stage "views" just refer to these global variables, they all have the same model
var observations,
    site_filter = ["CTT100 "],
    species_filter = {
      exclude_set: d3.set(),
      // exclude_list: ['Sub-catchment', 'Site', 'Year', 'date', 'Date', '???'],
      exclude_regex: [/.*-1/i]
    };

// ['Sub-catchment', 'Site', 'Year', 'date', 'Date', '???', '???-1', 'year-1']
['Fluoride (mg/L)', 'Temperature (Degrees C)', 'Temperature (Degrees C)', 'rain', 'temp'].forEach(function(d){
  species_filter.exclude_set.add(d);
});

// VIEWS
var cross_correlation_graph = new Cross_correlation_graph();
var sites = new Sites();
var species = new Species();

// LISTENERS
function set_observations(d){
  observations = d;
  cross_correlation_graph.draw_site();
  sites.draw();
  species.draw();
}

function set_species_filter(list, regex){
  species_filter.exclude_set = d3.set();
  list.forEach(function(d){
      species_filter.exclude_set.add(d);
  });
  ['Sub-catchment', 'Site', 'Year', 'date', 'Date', '???', '???-1', 'year-1'].forEach(function(d){
      species_filter.exclude_set.remove(d);
  });
  cross_correlation_graph.draw_site();
  species.draw();
}

function toggle_species_filter(name, regex){
  if (name) {
    if (species_filter.exclude_set.has(name)) species_filter.exclude_set.remove(name);
    else species_filter.exclude_set.add(name);
    // species_filter.exclude_list = list;
  }
  if (regex) species_filter.exclude_regex = regex;
  cross_correlation_graph.draw_site();
  species.draw();
}

function set_site_filter(d){
  site_filter = d;
  cross_correlation_graph.draw_site();
  sites.draw();
}


// initialize 
d3.csv("Tuggeranong_out.csv", function(error, data) {

  var parseDate = d3.time.format("%d %m %Y").parse;

  for (var i = 0; i < data.length; i++) {
    data[i].date = parseDate(data[i].Date);
  };

  var nested = d3.nest()
        .key(function(d){ return d.Site })
        .map(data, d3.map);

  // console.log(Object.keys(nested.values()[0][0]), d3.keys(nested.get(site_filter[0])[0]) );

  // so color remains constant with removals

  // cross_correlation_graph.color.domain(Object.keys(nested.values()[0][0]));

  d3.select('#species-all').on('click', function(){
    var all_species = Object.keys(nested.values()[0][0]);
    set_species_filter(all_species);
  });

  d3.select('#species-none').on('click', function(){
    set_species_filter([]);
  });

  set_observations(nested);


});




</script>