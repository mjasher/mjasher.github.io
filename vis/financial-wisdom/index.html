<!DOCTYPE html>
<meta charset="utf-8">
<style>
body {
    font: 10px sans-serif;
}
.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}
.area {
    fill: steelblue;
}
.drag-icon circle {
    fill: transparent;
    stroke: black;
}
.overlay {
    fill: none;
    pointer-events: all;
}
/*.focus circle {
    fill: none;
    stroke: darkred;
}*/
</style>

<link rel="stylesheet" href="../../third/reset.css">
<link rel="stylesheet" href="../../third/font-awesome-4.2.0/css/font-awesome.min.css">

<body>

    <div id="graph"></div>

    <script src="../../third/d3.min.js"></script>
    <script>
    var el = d3.select("#graph");

    var margin = {
            top: 120,
            right: 20,
            bottom: 30,
            left: 50
        },
        width = el.node().clientWidth - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;


    // var top_bar = svg.append('g')
    //     .attr("transform", "translate(" + margin.left + "," + 0 + ")");

    // top_bar.append('rect')
    //     .attr('width', width)
    //     .attr('height', 120)
    //     .style('fill', 'darkred');


    var svg = el.append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)

    var graphic = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var area_data = make_area_data();

    var x = d3.time.scale()
        .range([0, width])
        .domain(d3.extent(area_data, function(d) {
            return d.date;
        }));


    plot_area(graphic, width, height, area_data);

    function make_area_data() {

        var now = new Date().getFullYear();
        var data = [];
        for (var i = 0; i < 100; i++) {
            data.push({
                date: new Date(now + i, 1),
                value: i > 0 ? data[i - 1].value - 0.5 + Math.random() : Math.random()
            });
        };

        return data;
    }



    function plot_area(graphic, width, height, data) {

        /*
        set up graph
        */


        var y = d3.scale.linear()
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var area = d3.svg.area()
            .x(function(d) {
                return x(d.date);
            })
            .y0(height)
            .y1(function(d) {
                return y(d.value);
            });

        graphic.append("rect")
            .attr("class", "overlay")
            .attr("width", width)
            .attr("height", height)
            .on("mouseover", function() {
                over_area = true;
            })
            .on("mouseout", function() {
                over_area = false;
            });

        /*
        plot with data
        */

        // x.domain(d3.extent(data, function(d) {
        //     return d.date;
        // }));
        y.domain(d3.extent(data, function(d) {
            return d.value;
        }));
        // y.domain([0, d3.max(data, function(d) { return d.value; })]);

        graphic.append("path")
            .datum(data)
            .attr("class", "area")
            .attr("d", area)
            .attr('pointer-events', 'none');

        graphic.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        graphic.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Price ($)");

    }



    /*
    drag and drop events on SVG
    */

    var over_area = false;

    var bisectDate = d3.bisector(function(d) {
        return d.date;
    }).left;

    var drag = d3.behavior.drag()
        .on("dragstart", function() {
            d3.event.sourceEvent.stopPropagation(); // silence other listeners
            d3.select(this).attr('pointer-events', 'none'); // it's important that we suppress the mouseover event on the node being dragged. Otherwise it will absorb the mouseover event and the underlying node will not detect it
            // duplicate
            // TODO
        })
        .on("drag", function() {
            if (over_area) {

                // horizontal drag on graph

                //   var x0 = x.invert(d3.mouse(this)[0]),
                var x0 = x.invert(d3.event.x - margin.left),
                    i = bisectDate(area_data, x0, 1),
                    d0 = area_data[i - 1],
                    d1 = area_data[i],
                    d = x0 - d0.date > d1.date - x0 ? d1 : d0;

                verticalLine.attr("transform", "translate(" + (margin.left + x(d.date)) + ",0)");

                d3.select(this)
                    .attr("transform", "translate(" + (margin.left + x(d.date)) + "," + d3.event.y + ")");
            } else {
                d3.select(this)
                    .attr('transform', "translate(" + (d3.event.x) + "," + d3.event.y + ")");

                // remove
                // TODO
            }

        })
        .on("dragend", function() {
            d3.select(this).attr('pointer-events', ''); // now restore the mouseover event or we won't be able to drag a 2nd time
        });

    var verticalLine = svg.append('line')
        .attr('x1', 0)
        .attr('y1', 0)
        .attr('x2', 0)
        .attr('y2', margin.top + height)
        .attr("stroke", "black")
        .attr('class', 'verticalLine')
        .attr('pointer-events', 'none');

    var drag_icons = svg.append('g')
        .attr('class', 'drag-icon')
        .attr('transform', "translate(" + (margin.left + 40) + ",40)")
        .call(drag);

    drag_icons.append('circle')
        .attr('r', 20);

    drag_icons.append("foreignObject")
        .attr("width", 40)
        .attr("height", 40)
        .attr('x', -20)
        .attr('y', -20)
        .append("xhtml:body")
        .style({
            "font-size": "30px",
            "line-height": "40px",
            "text-align": "center"
        })
        // // .style("font", "14px 'Helvetica Neue'")
        .html("<i class='fa fa-home'></i>");







    // var drag_region_function = null;





                // focus.select('line').attr("transform", "translate(0," + -y(d.value) + ")");
                // focus.select("text").text(d.value);



    // var focus = graphic.append("g")
    //     .attr("class", "focus")
    //     // .style("display", "none");

    // focus.append("circle")
    //     .attr("r", 4.5);

    // focus.append("text")
    //     .attr("x", 9)
    //     .attr("dy", ".35em");


    // focus.append('line')
    //     .attr('x1', 0)
    //     .attr('y1', 0)
    //     .attr('x2', 0)
    //     .attr('y2', height)
                // focus.select('line').attr("transform", "translate(0," + -y(d.value) + ")");
                // focus.select("text").text(d.value);
    //     .attr("stroke", "darkred")
    //     .attr('class', 'verticalLine');

    // selection.on("click", function() {
    //   if (d3.event.defaultPrevented) return; // click suppressed
    //   console.log("clicked!");
    // });
    </script>

</body>

</html>