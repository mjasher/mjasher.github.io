<!DOCTYPE html>
<meta charset="utf-8">

<link rel="stylesheet" href="../../third/reset.css">
<link rel="stylesheet" href="../../third/pocketgrid.css">
<link rel="stylesheet" href="../../third/font-awesome-4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="css/main.css">

<body>

    <div id="app" class="container">
        <div class="heading">
            <p>This app is a graphic aid to decision making. One can specify a model and a number of inputs by editing the code (click on <i class="fa fa-code"></i>). A graph will be created which indicates the sensitivity of model outputs to changes in inputs. You can adjust the values for each input by dragging the graphs. </p>
            <p>The example deals with the decision to buy or rent a home. From the slopes and intersections of the graphs, one can see which factors are likely to make one option a better financial choice than the other.</p>
        </div>

        <div id="legend"></div>
        <div id="editor-button"> <i class="fa fa-code"></i> </div>

        <div id="editor" class="hidden"></div>
        <div id="graphs" class="block-group"></div>

    </div>


    <script id="init-editor" type="text/template">

        // initial values    
        var inputs = [
            {val: 0.04, min: 0, max: 0.1, tickFormat : '%', name: "Mortgage rate"}, // real rate (exclude inflation)
            {val: 0.03, min: 0, max: 0.1, tickFormat : '%',name: "Saving rate"}, // real rate (exclude inflation)
            {val: 0.02, min: 0, max: 0.1, tickFormat : '%',name: "House price increase rate"}, // real rate (exclude inflation)
            {val: 350000, min: 0, max: 2000000, tickFormat : '$,',name: "Purchase price of house"},
            {val: 350, min: 0, max: 2000,tickFormat : '$,', name: "Weekly rent"},
            {val: 15, min: 1, max: 50, tickFormat : '', name: "Mortgage term in years"}, 
            {val: 3000, min: 0, max: 10000, tickFormat : '$,', name: "Rates per year"}, // include land tax
            {val: 1000, min: 0, max: 20000, tickFormat : '$,', name: "Upkeep per year"}, // fixing stuff
            {val: 200, min: 0, max: 1000, tickFormat : '$,', name: "Annual cost of moving"}, // annual moving cost for renting
        ];


        function yearly_repayment(h){
            if (h["Mortgage rate"] === 0) return h["Purchase price of house"]/h["Mortgage term in years"]; // TODOD fix
            return h["Purchase price of house"]*h["Mortgage rate"]/(1-(1/Math.pow(1+h["Mortgage rate"],h["Mortgage term in years"])));
        }

        function end_buying(h){
            return h["Purchase price of house"]*Math.pow(1+h["House price increase rate"],h["Mortgage term in years"]);
        }

        function end_renting(h){
            var buying_cost = yearly_repayment(h) + h["Upkeep per year"] + h["Rates per year"];
            var renting_cost = h["Weekly rent"]*52 + h["Annual cost of moving"];
            
            var rent_savings = 0;
            for (var i=0;i<h["Mortgage term in years"];i++){
              rent_savings += (buying_cost - renting_cost) * Math.exp(h["Saving rate"] * (h["Mortgage term in years"]-i-1));
            }

            return rent_savings;
        }

        function model(inputs){
            var p = {};

            for (var i = 0; i < inputs.length; i++) {
                p[inputs[i].name] = inputs[i].val;
            }

            return {
                "value of home if buying ($)": end_buying(p),
                "saved cash if renting ($)": end_renting(p)
            }

        }

    </script>

    <script src="../../third/jquery-1.11.0.min.js"></script>
    <script src="../../third/underscore.min.js"></script>
    <script src="../../third/backbone.min.js"></script>
    <script src="../../third/ace/ace.js"></script>
    <script src="../../third/ace/ext-language_tools.js"></script>

    <script src="../../third/d3.min.js"></script>

    <script src='js/views.js'></script>
    <script>


    /* 
    TODO 
    ----

    * replace jquery event listening with d3 - see https://github.com/jashkenas/backbone/wiki/Using-Backbone-without-jQuery
    * window.onresize = draw
    */



    /*----------------------
    Initialize
    ----------------------*/

    var inputs, model;

    var editor = ace.edit("editor");

    var inputCollection = new Backbone.Collection;

    var appView = new AppView;

    editor.setValue(d3.select("#init-editor").html());




    </script>

</body>

</html>