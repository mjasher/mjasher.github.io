<!DOCTYPE html>
<meta charset="utf-8">

<link rel="stylesheet" href="../../third/reset.css">
<link rel="stylesheet" href="../../third/pocketgrid.css">
<link rel="stylesheet" href="../../third/font-awesome-4.2.0/css/font-awesome.min.css">
<style>
.container {
    margin: auto;
    width: 100%;
    max-width: 1200px;
}
.block {
    width: 50%;
}
@media screen and (max-width: 700px) {
    .block {
        width: 100%;
    }
}
body {
    font: 10px sans-serif;
}
.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}
.line {
    fill: none;
    stroke-width: 1.5px;
}
.focus circle {
    fill: none;
}
.overlay {
    fill: none;
    pointer-events: all;
}
#editor {
    margin: 0;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
}
#editor-button {
    height: 50px;
    width: 50px;
    border-radius: 25px;
    background-color: darkred;
    cursor: pointer;
    position: absolute;
    right: 0;
    top: 0;
    z-index: 10;
    text-align: center;
    line-height: 48px;
    font-size: 35px;
}
.hidden {
    display: none;
}
</style>

<body>

    <div id="app" class="container">

        <div id="editor-button"> <i class="fa fa-code"></i> </div>

        <div id="editor" class="hidden"></div>
        <div id="graphs" class="block-group"></div>

    </div>


    <script id="init-editor" type="text/template">

var inputs = [{
    name: "sale_price_per_m2",
    val: 580000 / (112 + 17),
    min: 0.9 * 580000 / (112 + 17),
    max: 1.1 * 580000 / (112 + 17)
}, {
    name: "construction_cost_per_m2",
    val: 1800,
    min: 0.9 * 1800,
    max: 1.1 * 1800
}, ];

function interest(principal, rate, years) {
    return principal * Math.pow(Math.E, (rate * years)) - principal;
}

// should take {input_1_name: {val: input_1_value, min: m1, max: M1}, ... } and return outputs {output_1_name: output_1_value, ... }

function model(inputs) {

    var sale_price_per_m2 = inputs.filter(function(d) {
        return d.name === "sale_price_per_m2";
    })[0].val;
    var construction_cost_per_m2 = inputs.filter(function(d) {
        return d.name === "construction_cost_per_m2";
    })[0].val;
    // var construction_cost_per_m2 = inputs[0]["construction_cost_per_m2"].val;


    var property_area = 2100;

    var land_cost = 1650000;

    var floor_ratio = 0.65;

    var for_sale_ratio = 0.8;


    var sale_price = for_sale_ratio * sale_price_per_m2 * floor_ratio * property_area;

    var parking_area = 300;
    var parking_cost_per_m2 = 1000;
    var parking_cost = parking_area * parking_cost_per_m2;

    var construction_cost = construction_cost_per_m2 * floor_ratio * property_area;


    var planning_years = 1;
    var construction_years = 1;
    var interest_rate = 0.05;
    var interest_cost = interest(land_cost, interest_rate, planning_years + construction_years) + interest(construction_cost + parking_cost, interest_rate, construction_years);

    var profit = sale_price - construction_cost - parking_cost - land_cost - interest_cost;

    // define outputs
    return {
        "profit": profit,
        "junk": sale_price_per_m2
    };

}
    </script>

    <script src="../../third/jquery-1.11.0.min.js"></script>
    <script src="../../third/underscore.min.js"></script>
    <script src="../../third/backbone.min.js"></script>
    <script src="../../third/ace/ace.js"></script>
    <script src="../../third/ace/ext-language_tools.js"></script>

    <script src="../../third/d3.min.js"></script>
    <script>
    /*----------------------

            Nav

            ----------------------*/

    // TODO replace jquery event listening with d3
    // https://github.com/jashkenas/backbone/wiki/Using-Backbone-without-jQuery


    var inputs, model;

    var AppView = Backbone.View.extend({

        el: $("#app"),

        events: {
            "click #editor-button": "toggleEditor",
            // window.onresize = draw;
            // TODO 

        },

        initialize: function() {
            // this.listenTo(inputCollection, 'reset', this.resetInputs);          
            this.listenTo(inputCollection, 'add', this.addInput);

            /*----------------------
                    Ace 
            ----------------------*/



            var language_tools = ace.require("ace/ext/language_tools");
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true
            });

            editor.getSession().setMode("ace/mode/javascript");
            editor.setTheme("ace/theme/twilight");

            editor.on('change', function() {

                // should define inputs and model
                console.log("EDITOR CHANGE", editor.getSession().getValue().slice(0,10));

                
                // equivalent to eval but ensures inputs and model are global
                // eval(editor.getSession().getValue());
                var oldScript = document.getElementById('model-input-script');
                oldScript && oldScript.parentNode.removeChild(oldScript);
                var code = editor.getSession().getValue();
                var script = document.createElement('script');
                script.id = 'model-input-script';
                try {
                  script.appendChild(document.createTextNode(code));
                  document.body.appendChild(script);
                } catch (e) {
                  script.text = code;
                  document.body.appendChild(script);
                }


                var now = 0;
                function check_until(){
                    if (inputs && model){

                        // callback
                        // remove old inputs
                        var temp_model;
                        while (temp_model = inputCollection.first()) {
                            temp_model.destroy();
                        }
                        // add new
                        inputCollection.add(inputs);

                         console.log("CHANGES", inputs, model, editor.getSession().getValue().slice(0,10));
                    }
                    else if(now>100) {}
                    else {
                        now += 1;
                        setTimeout(check_until, 100);
                    }
                }
                check_until()



            })


        },

        toggleEditor: function() {
            var icon = this.$("#editor-button i");
            if (icon.hasClass('fa-code')) {
                icon.toggleClass('fa-code', false);
                icon.toggleClass('fa-times', true);
                $("#editor").toggleClass('hidden', false);
            } else {
                icon.toggleClass('fa-times', false);
                icon.toggleClass('fa-code', true);
                $("#editor").toggleClass('hidden', true);
            }
        },

        // resetInputs: function(inputs) {
        //   inputCollection.each(this.addInput);
        // },

        addInput: function(input) {
            var view = new InputView({
                model: input,
                el: d3.select("#graphs").append('div').attr('class', 'block').node()
            });
            view.render();

            // this.$("#graphs").append(view.render().el);
        },

    });



    var InputView = Backbone.View.extend({
        // tagname: "div",
        // className: "block",

        events: {
            // "keypress #new-todo": "createOnEnter",
            // TODO drag event here
        },

        initialize: function() {
            this.listenTo(this.model.collection, "change", this.render);
            this.listenTo(this.model, "destroy", this.remove);
        },

        render: function() {

            var this_model = this.model;

            var el = d3.select(this.el);

            el.selectAll('svg').remove();

            var input = this.model.toJSON();
            var inputs = this.model.collection.toJSON();
            var outputs = Object.keys(model(inputs));

            var index = this.model.collection.indexOf(this.model);


            /*----------------------
            Set up plot 
            ----------------------*/

            var margin = {
                    top: 20,
                    right: 20,
                    bottom: 30,
                    left: 60
                },
                // width = parseInt(el.style('width'), 10) - margin.left - margin.right,
                // width = 300 - margin.left - margin.right,
                width = el.node().clientWidth - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var x = d3.scale.linear()
                .range([0, width]);

            var y = d3.scale.linear()
                .range([height, 0]);

            var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom");

            var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left");

            var line = d3.svg.line()
                .x(function(d) {
                    return x(d.x);
                })
                .y(function(d) {
                    return y(d.y);
                });

            var svg = el.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var color = d3.scale.category10().domain(outputs);


            /*----------------------
            Create data and plot it
            ----------------------*/

            var points = 100;

            var step = (input.max - input.min) / points;
            var domain = [];
            for (var i = 0; i < points; i++) {
                domain.push(input.min + i * step);
            };


            var data = outputs.map(function(output) {
                var temp_inputs = clone(inputs);

                return {
                    name: output,
                    data: domain.map(function(d) {
                        temp_inputs[index].val = d; // changes object
                        return {
                            x: d,
                            y: model(temp_inputs)[output]
                        };
                    })
                };

            });

            x.domain([
                d3.min(data, function(l) {
                    return d3.min(l.data, function(d) {
                        return d.x;
                    });
                }),
                d3.max(data, function(l) {
                    return d3.max(l.data, function(d) {
                        return d.x;
                    });
                })
            ]);

            y.domain([
                d3.min(data, function(l) {
                    return d3.min(l.data, function(d) {
                        return d.y;
                    });
                }),
                d3.max(data, function(l) {
                    return d3.max(l.data, function(d) {
                        return d.y;
                    });
                })
            ]);

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Price ($)");

            for (var i = 0; i < data.length; i++) {
                svg.append("path")
                    .datum(data[i].data)
                    .attr("class", "line")
                    .style('stroke', color(data[i].name))
                    .attr("d", line);
            }


            /*----------------------
            Hover/ Drag
            ----------------------*/

            var drag = d3.behavior.drag()
                .on("drag", mousemove)
                .on("dragend", function() {
                    this_model.set(input);
                    this_model.collection.trigger('change');
                });
            // TODO

            var bisectX = d3.bisector(function(d) {
                return d.x;
            }).left;

            var focus = svg.selectAll(".focus")
                .data(outputs)
                .enter()
                .append("g")
                .attr("class", "focus")
                .attr("transform", function(e, j) {
                    return "translate(" + x(input.val) + "," + y(model(inputs)[e]) + ")";
                });

            focus.append("circle")
                .style('stroke', function(d) {
                    return color(d);
                })
                .attr("r", width / 100);

            focus.append("text")
                .attr("x", 9)
                .attr("dy", ".35em")
                .text(function(e, j) {
                    return model(inputs)[e].toFixed(2);
                });

            svg.append("rect")
                .attr("class", "overlay")
                .attr("width", width)
                .attr("height", height)
                .call(drag);

            function mousemove() {
                var x0 = x.invert(d3.mouse(this)[0]),
                    i = bisectX(data[0].data, x0, 1),
                    d0 = data[0].data[i - 1],
                    d1 = data[0].data[i],
                    i_b = x0 - d0.x > d1.x - x0 ? i : i - 1;

                input.val = x0 - d0.x > d1.x - x0 ? d1.x : d0.x;

                focus.attr("transform", function(e, j) {
                    return "translate(" + x(data[j].data[i_b].x) + "," + y(data[j].data[i_b].y) + ")";
                });
                focus.select("text").text(function(e, j) {
                    return data[j].data[i_b].y.toFixed(2)
                });


            }

            return this;

        }

    });





    /*----------------------
    Nav
    ----------------------*/

    // d3.select("#editor-button")
    //     .on('click', function() {
    //         var icon = d3.select(this).select('i')
    //         if (icon.classed('fa-code')) {
    //             icon.classed('fa-code', false);
    //             icon.classed('fa-times', true);
    //             d3.select("#editor").classed('hidden', false);
    //         } else {
    //             icon.classed('fa-times', false);
    //             icon.classed('fa-code', true);
    //             d3.select("#editor").classed('hidden', true);
    //         }
    //     });





    /*----------------------

    Helpers

    ----------------------*/




    /*----------------------

    Model globals used in visualisation

    ----------------------*/


    // var inputs = {
    //     "sale_price_per_m2": {
    //         val: 580000 / (112 + 17),
    //         min: 0.9 * 580000 / (112 + 17),
    //         max: 1.1 * 580000 / (112 + 17)
    //     },
    //     "construction_cost_per_m2": {
    //         val: 1800,
    //         min: 0.9 * 1800,
    //         max: 1.1 * 1800
    //     },
    // }

    var editor = ace.edit("editor");

    var inputCollection = new Backbone.Collection;

    var appView = new AppView;

    editor.setValue(d3.select("#init-editor").html());


    // on init and editor change

    // eval(editor.getSession().getValue())
    // error if inputs not defines!




    // inputCollection.add([{
    //     name: "sale_price_per_m2",
    //     val: 38000000 / (112 + 17),
    //     min: 0.9 * 38000000 / (112 + 17),
    //     max: 1.1 * 38000000 / (112 + 17)
    // }, {
    //     name: "construction_cost_per_m2",
    //     val: 480000,
    //     min: 0.9 * 480000,
    //     max: 1.1 * 480000
    // }, ]);

    // it looks like 'reset' event is triggered only after models 'removed', no other events called





    function isObject(obj) {
        var type = typeof obj;
        return type === 'function' || type === 'object' && !!obj;
    };

    function clone(obj) {
        if (null == obj || "object" != typeof obj) return obj;
        var copy = obj.constructor();
        for (var attr in obj) {
            if (isObject(obj[attr])) copy[attr] = clone(obj[attr]); // mja
            else if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
        }
        return copy;
    }






    // var input_keys = Object.keys(inputs);
    // function draw() {
    //     d3.selectAll("#graphs div").remove();
    //     for (var i = 0; i < input_keys.length; i++) {
    //         plot(d3.select("#graphs").append('div').attr("class", "block"), input_keys[i]);
    //     };

    // }

    // draw();
    // window.onresize = draw;
    </script>




</body>

</html>